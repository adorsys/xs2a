### Prerequisites

- Java JDK version 1.8.x, Maven 3.x
- Relational database for consent-management-system. We recommend to use PostgreSQL 9.5
- Docker (Optional)

In order to use our Mock server for tests you'd need additionally
- MongoDB for persistent mocks;
- Keycloak IDP-Server. We also recommend to use PostgreSQL 9.5 for persistence here.

### Setting up and running development environment

If you are using Docker you may speed up your startup by using the docker-compose file.
This file starts all services for development with mock, except the main XS2A service.
The important prerequirement for using mock-server is to setup keycloak server before.

#### Initial setup of keycloak server

Download and run keycloak (port 8081):

`Windows`
```bash
> ...\bin\standalone.bat -Djboss.http.port=8081
```
`UNIX` (`BSD`, `Linux` or `MacOS`)
```bash
$ .../bin/standalone.sh -Djboss.http.port=8081
```

By default, keycloak starts with in-memory database H2. In order to have it persistent one needs to setup a relational database for it.
We recommend to setup PostgreSQL database.

You may use a keycloak docker image `jboss/keycloak:3.4.3.Final` for it as well

After keycloak starts and listens on port `8081` you may run keycloak scripts that create realm and one user:
```bash
$ cd scripts/keycloak-dev
$ ./init-realm-and-client.sh
```

The user with username `admin` and password `admin123` will be used for keycloak administration then.
The user with username `aspsp` and password `zzz` will be used for accessing the aspsp-mock-server api then.
Please note that Keycloak creates realms and clients with some secrets, need to be passed to your environment.

### Clone git repository and build a project:
```bash
$ git clone https://github.com/adorsys/xs2a.git
$ cd xs2a
$ mvn clean install
```

### Run an ASPSP-Mock-Server:
```bash
$ cd aspsp-mock-server
$ KEYCLOAK_CREDENTIALS_SECRET="xyz" mvn spring-boot:run -Drun.profiles=fongo
```
Where `xyz` - a client-secret generated by keycloak for `aspsp-mock` client.

Open a browser on page [http://localhost:28080/swagger-ui.html](http://localhost:28080/swagger-ui.html)

By default ASPSP-Mock-Server would use fongo im-memory database. If you'd like to persist data, you may use real MongoDB instead.

### Run an ASPSP-Profile:
```bash
$ cd aspsp-profile/aspsp-profile-server
$ mvn spring-boot:run
```
Open a browser on page [http://localhost:48080/api/v1/swagger-ui.html](http://localhost:48080/api/v1/swagger-ui.html)

### Run a Consent-Management-System server:
First of all you need to setup a relational database for it.
We recommend to use PostgreSQL.
Default parameters for that DB one can find in the `liquibase.example.properties`:

| Parameter   | Value     |
|-------------|-----------|
| DB Host     | localhost |
| DB Port     | 5432      |
| DB Name     | consent   |
| DB Schema   | consent   |
| DB User     | cms       |
| DB Password | cms       |

Setup a database and db schema.
Then create tables using liquibase:
```bash
$ cd consent-management/cms-db-schema
$ cp liquibase.example.properties liquibase.properties
$ mvn liquibase:update
```
Now, once PostgreSQL-server is running on port `5432` you may run consent-management-system server:
```bash
$ cd consent-management/consent-management-system
$ mvn spring-boot:run
```
Open a browser on page [http://localhost:38080/swagger-ui.html](http://localhost:38080/swagger-ui.html)

### Run a XS2A-Server:
By default XS2A-library shall be packed with the ASPSP-Connector, that connects the library to the corresponding ASPSP-systems.
For initial startup and testing purposes one can use the connector to the aforementioned aspsp-mock-server.
To start the XS2A with ASPSP-Mock-Connector do:
```bash
$ cd spi-mock
$ KEYCLOAK_CREDENTIALS_SECRET="xyz" mvn spring-boot:run 
```
Where `xyz` - a client-secret generated by keycloak for `xs2a-impl` client.


Open a browser on page [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)

Now you may try to put some data using the mock-server and to access it using the xs2a-interface.
See [some test scripts for Postman](scripts/tests/postman) as a starting point.
