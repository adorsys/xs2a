# Getting started

## Prerequisites

- Java JDK version 1.8.x, Maven 3.x;
- Relational database for consent-management-system. We recommend to use PostgreSQL 9.5;
- Docker (Optional).

In order to use our Mock server for tests you'd need additionally:
- MongoDB for persistent mocks;
- Keycloak IDP-Server. We also recommend to use PostgreSQL 9.5 for persistence here.

## Setting up and running development environment

If you are using Docker you may speed up your startup by using the docker-compose file.
This file starts all services for development with mock, except the main XS2A service.
The important prerequisites for using mock-server is to setup keycloak server before and
to put the client secrets into environment variables using the `.env`-file.

### Clone git repository and build a project:
```bash
$ git clone https://github.com/adorsys/xs2a.git
$ cd xs2a
$ mvn clean install
```

### Use docker-compose

There is docker-compose.yml in root folder which will help to run containers in docker.
Some images will be build from sources, some fetched prebuild from docker hub.

UI component should be built before docker images were created.
```
$ cd online-banking-demo-ui && npm ci && npm run build && cd ..
```
After UI build completes please start docker compose.
```
$ docker-compose up
```


### Initial setup of keycloak server

Download and run keycloak (port 8081):

`Windows`
```bash
> ...\bin\standalone.bat -Djboss.http.port=8081
```
`UNIX` (`BSD`, `Linux` or `MacOS`)
```bash
$ .../bin/standalone.sh -Djboss.http.port=8081
```

By default, keycloak starts with in-memory database H2. In order to have it persistent one needs to setup a relational database for it.
We recommend to setup PostgreSQL database.

You may use a keycloak docker image `jboss/keycloak:3.4.3.Final` for it as well

After keycloak starts and listens on port `8081` you may run keycloak scripts that create realm and one user:
```bash
$ cd scripts/keycloak-dev
$ ./init-realm-and-client.sh
```
You should see new realm, client and user created in your keycloak.

Please note clients should be created with ``Access Type`` bearer-only and there should be tab named Credentials where you can get client secret, used in next step. ![client secret](images/keycloakClientSecret.png)

In case tab Credentials are not visible, please toggle ``Access Type`` setting on tab ``Settings`` (change to public, save and change back to bearer-only).

The user with username `admin` and password `admin123` will be used for keycloak administration then.
The user with username `aspsp` and password `zzz` will be used for accessing the aspsp-mock-server api then.
Please note that Keycloak creates realms and clients with some secrets, need to be passed to your environment.

### Run an ASPSP-Mock-Server:
```bash
$ cd aspsp-mock-server
$ mvn spring-boot:run -dKEYCLOAK_CREDENTIALS_SECRET="xyz" -Drun.profiles=fongo
```
Where `xyz` - a client-secret generated by keycloak for `aspsp-mock` client.

Open a browser on page [http://localhost:28080/swagger-ui.html](http://localhost:28080/swagger-ui.html)

By default ASPSP-Mock-Server will use fongo im-memory database. 
If you'd like to persist data, you may use real MongoDB instead.

### Run an ASPSP-Profile:
```bash
$ cd aspsp-profile/aspsp-profile-server
$ mvn spring-boot:run
```
Open a browser on page [http://localhost:48080/swagger-ui.html](http://localhost:48080/swagger-ui.html)

### Run a Consent-Management-System server:
First of all you need to setup a relational database for it.
We recommend to use PostgreSQL.
Default parameters for that DB one can find in the `liquibase.example.properties`:

| Parameter   | Value     |
|-------------|-----------|
| DB Host     | localhost |
| DB Port     | 5432      |
| DB Name     | consent   |
| DB Schema   | consent   |
| DB User     | cms       |
| DB Password | cms       |

Setup a database and db schema.

Then create tables using liquibase:
```bash
$ cd consent-management/cms-db-schema
$ cp liquibase.example.properties liquibase.properties
$ mvn liquibase:update
```

Now, once PostgreSQL-server is running on port `5432` you may run consent-management-system server:
```bash
$ cd consent-management/cms-standalone-service
$ mvn -Drun.arguments=--server_key=12345678 spring-boot:run
```
Open a browser on page [http://localhost:38080/swagger-ui.html](http://localhost:38080/swagger-ui.html)

### Run a XS2A-Server:
By default XS2A-library shall be packed with the ASPSP-Connector, that connects the library to the corresponding ASPSP-systems.
For initial startup and testing purposes one can use the connector to the aforementioned aspsp-mock-server.
To start the XS2A with ASPSP-Mock-Connector do:
```bash
$ cd spi-mock
$ mvn -DKEYCLOAK_CREDENTIALS_SECRET="xyz" spring-boot:run 
```
Where `xyz` - a client-secret generated by keycloak for `xs2a-impl` client.


Open a browser on page [http://localhost:8080/swagger-ui.html](http://localhost:8080/swagger-ui.html)

Now you may try to put some data using the mock-server and to access it using the xs2a-interface.
See some test scripts [for Postman](../scripts/tests/postman) or [Insomnia](../scripts/tests/insomnia) as a starting point.
